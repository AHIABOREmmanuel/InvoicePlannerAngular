import{a as Y}from"./chunk-7JWM6KR5.js";import{b as je,c as pe}from"./chunk-NHUORNJV.js";import{a as Ue,b as Be,c as qe,d as $e}from"./chunk-2RL62OKR.js";import{a as me}from"./chunk-X2ACQ5VV.js";import"./chunk-4WB3XNKJ.js";import"./chunk-G56B72LT.js";import"./chunk-F2X3VGZZ.js";import{a as ce}from"./chunk-MTXOG7JB.js";import{a as Qe}from"./chunk-4XYTC4J5.js";import{a as Ve}from"./chunk-G6V6HJYU.js";import{c as B,d as g,f as q,g as ie,i as $,j as ne,k as re,l as oe,m as le,n as ae,o as se,p as G,q as H,r as z,s as de,t as ke,u as Le}from"./chunk-DY3BU5YN.js";import{U as j,W as U}from"./chunk-R3DGKUZX.js";import{$ as t,$a as Fe,Aa as L,Ba as be,Ca as O,Ea as J,G as Q,Ga as E,H as l,Ha as Ee,Ia as y,L as C,N as M,O as te,S as _,Ua as we,V as c,Va as N,Wa as R,Za as Me,_a as V,aa as e,ba as m,bb as Ae,d as _e,fa as S,ga as x,ha as f,i as he,j as Pe,mb as Oe,nb as Ne,o as ee,ob as W,pb as Re,ra as i,rb as K,sa as v,t as h,ta as p,u as b,ua as D,wa as F,xa as A,ya as k,za as Ie}from"./chunk-NRBLYFRS.js";import{g as Ye}from"./chunk-VOSPIT4N.js";var P=Ye(Qe());var Je=()=>["/dashboard"],Se=()=>["add-devis"],Ke=a=>["/dashboard/devis/edit-devis",a],X=(a,o)=>({"btn-primary":a,"btn-outline-primary":o}),Xe=(a,o,n,r)=>({"bg-light":a,"bg-info-subtle":o,"bg-success-subtle":n,"bg-danger-subtle":r}),Ze=(a,o,n,r)=>({"bg-secondary":a,"bg-info":o,"bg-success":n,"bg-danger":r}),et=(a,o,n,r)=>({"ti-pencil":a,"ti-send":o,"ti-check":n,"ti-x":r}),tt=a=>["edit-devis",a],it=(a,o,n,r)=>({"badge bg-secondary":a,"badge bg-info":o,"badge bg-success":n,"badge bg-danger":r}),nt=()=>[];function rt(a,o){a&1&&(t(0,"div",39)(1,"div",40)(2,"span",41),i(3,"Chargement..."),e()(),t(4,"p",42),i(5,"Chargement des devis..."),e()())}function ot(a,o){if(a&1&&(t(0,"div",43)(1,"div",44),m(2,"i",45),t(3,"div"),i(4),e()()()),a&2){let n=f();l(4),v(n.errorMessage)}}function lt(a,o){a&1&&(t(0,"div",39)(1,"div",46),m(2,"i",47),e(),t(3,"h4"),i(4,"Aucun devis disponible"),e(),t(5,"p",48),i(6,"Vous n'avez pas encore cr\xE9\xE9 de devis."),e(),t(7,"button",49),m(8,"i",15),i(9,"Cr\xE9er votre premier devis "),e()()),a&2&&(l(7),c("routerLink",L(1,Se)))}function at(a,o){if(a&1){let n=S();t(0,"button",94),x("click",function(s){h(n);let u=f().$implicit;return f(3).convertToFacture(u),b(s.stopPropagation())}),m(1,"i",95),i(2," Facture "),e()}}function st(a,o){a&1&&(t(0,"div",96)(1,"div",97)(2,"div",98),m(3,"i",99),e(),t(4,"h4"),i(5,"Aucun devis trouv\xE9"),e(),t(6,"p",77),i(7," Il n'y a pas de devis correspondant \xE0 votre recherche "),e(),t(8,"button",49),m(9,"i",100),i(10,"Cr\xE9er un devis "),e()()()),a&2&&(l(8),c("routerLink",L(1,Se)))}function dt(a,o){if(a&1){let n=S();t(0,"div",62)(1,"div",63)(2,"div",64)(3,"div",65)(4,"div")(5,"span",66),m(6,"i",67),i(7),E(8,"titlecase"),e()(),t(9,"div")(10,"select",68),k("ngModelChange",function(s){let u=h(n).$implicit;return A(u.statut,s)||(u.statut=s),b(s)}),x("change",function(){let s=h(n).$implicit,u=f(3);return b(u.updateDevisStatus(s))})("click",function(s){return h(n),b(s.stopPropagation())}),t(11,"option",69),i(12,"Brouillon"),e(),t(13,"option",70),i(14,"Envoy\xE9"),e(),t(15,"option",71),i(16,"Accept\xE9"),e(),t(17,"option",72),i(18,"Refus\xE9"),e()()()()(),t(19,"div",73),x("click",function(){let s=h(n).$implicit,u=f(3);return b(u.openDetailsModal(s))}),t(20,"h5",74),i(21),e(),t(22,"div",48)(23,"div",75),m(24,"i",76),t(25,"span",77),i(26,"R\xE9f: "),e(),t(27,"span",78),i(28),e()(),t(29,"div",75),m(30,"i",79),t(31,"span",77),i(32,"Client: "),e(),t(33,"span",80),i(34),e()(),t(35,"div",75),m(36,"i",81),t(37,"span",77),i(38,"\xC9mis le: "),e(),t(39,"span",78),i(40),E(41,"date"),e()(),t(42,"div",82),m(43,"i",83),t(44,"span",77),i(45,"Montant: "),e(),t(46,"span",84),i(47),E(48,"currency"),e()()()(),t(49,"div",85)(50,"div")(51,"button",86),x("click",function(s){return h(n),b(s.stopPropagation())}),m(52,"i",87),e(),t(53,"button",88),x("click",function(s){let u=h(n).$implicit;return f(3).deleteDevis(u),b(s.stopPropagation())}),m(54,"i",89),e()(),t(55,"div")(56,"button",90),x("click",function(s){let u=h(n).$implicit;return f(3).downloadDevis(u),b(s.stopPropagation())}),m(57,"i",91),e(),_(58,at,3,0,"button",92),e()()(),_(59,st,11,2,"div",93),e()}if(a&2){let n=o.$implicit,r=f(3);l(2),c("ngClass",J(21,Xe,n.statut==="BROUILLON",n.statut==="ENVOYE",n.statut==="ACCEPTE",n.statut==="REFUSE")),l(3),c("ngClass",J(26,Ze,n.statut==="BROUILLON",n.statut==="ENVOYE",n.statut==="ACCEPTE",n.statut==="REFUSE")),l(),c("ngClass",J(31,et,n.statut==="BROUILLON",n.statut==="ENVOYE",n.statut==="ACCEPTE",n.statut==="REFUSE")),l(),p(" ",Ee(8,13,n.statut)," "),l(3),F("ngModel",n.statut),l(11),v(n.nomProjet),l(7),v(n.reference),l(6),v(n.clientName||n.clientTrackingId),l(6),v(y(41,15,n.dateEmission,"dd/MM/yyyy")),l(7),v(y(48,18,n.prixTTC,"CFA")),l(4),c("routerLink",be(36,tt,n.trackingId)),l(7),c("ngIf",n.statut==="ACCEPTE"),l(),c("ngIf",!r.isLoading&&!r.errorMessage&&r.filteredDevis.length===0)}}function mt(a,o){if(a&1&&(t(0,"div",43)(1,"div",51),_(2,dt,60,38,"div",61),e()()),a&2){let n=f(2);l(2),c("ngForOf",n.filteredDevis)}}function ct(a,o){if(a&1){let n=S();t(0,"div",50)(1,"div",51)(2,"div",52)(3,"div",53)(4,"span",54),m(5,"i",55),e(),t(6,"input",56),k("ngModelChange",function(s){h(n);let u=f();return A(u.searchTerm,s)||(u.searchTerm=s),b(s)}),x("ngModelChange",function(){h(n);let s=f();return b(s.applyFilters())}),e()()(),t(7,"div",57)(8,"div",58)(9,"div",59)(10,"button",60),x("click",function(){h(n);let s=f();return b(s.filterDevis("tous"))}),i(11," Tous "),e(),t(12,"button",60),x("click",function(){h(n);let s=f();return b(s.filterDevis("BROUILLON"))}),i(13," Brouillons "),e(),t(14,"button",60),x("click",function(){h(n);let s=f();return b(s.filterDevis("ENVOYE"))}),i(15," Envoy\xE9s "),e(),t(16,"button",60),x("click",function(){h(n);let s=f();return b(s.filterDevis("ACCEPTE"))}),i(17," Accept\xE9s "),e(),t(18,"button",60),x("click",function(){h(n);let s=f();return b(s.filterDevis("REFUSE"))}),i(19," Refus\xE9s "),e()()()()(),_(20,mt,3,1,"div",24),e()}if(a&2){let n=f();l(6),F("ngModel",n.searchTerm),l(4),c("ngClass",O(7,X,n.activeFilter==="tous",n.activeFilter!=="tous")),l(2),c("ngClass",O(10,X,n.activeFilter==="BROUILLON",n.activeFilter!=="BROUILLON")),l(2),c("ngClass",O(13,X,n.activeFilter==="ENVOYE",n.activeFilter!=="ENVOYE")),l(2),c("ngClass",O(16,X,n.activeFilter==="ACCEPTE",n.activeFilter!=="ACCEPTE")),l(2),c("ngClass",O(19,X,n.activeFilter==="REFUSE",n.activeFilter!=="REFUSE")),l(2),c("ngIf",!n.isLoading&&!n.errorMessage&&n.filteredDevis&&n.filteredDevis.length>0)}}function pt(a,o){if(a&1&&(t(0,"h5",101),i(1),e()),a&2){let n=f();l(),p(" D\xE9tails du devis - ",n.selectedDevis.reference," ")}}function ut(a,o){if(a&1&&(t(0,"p",105)(1,"strong"),i(2,"Validation:"),e(),i(3),E(4,"date"),e()),a&2){let n=f(2);l(3),p(" ",y(4,1,n.selectedDevis.dateEmission,"dd/MM/yyyy")," ")}}function vt(a,o){if(a&1&&(t(0,"p",105)(1,"strong"),i(2,"Nom:"),e(),i(3),e()),a&2){let n=f(2);l(3),p(" ",n.selectedDevis.clientName," ")}}function ft(a,o){if(a&1&&(t(0,"p",105)(1,"strong"),i(2,"Email:"),e(),i(3),e()),a&2){let n=f(2);l(3),p(" ",n.selectedDevis.clientEmail," ")}}function xt(a,o){if(a&1&&(t(0,"tr")(1,"td"),i(2),e(),t(3,"td",111),i(4),e(),t(5,"td",111),i(6),E(7,"currency"),e(),t(8,"td",111),i(9),E(10,"currency"),e()()),a&2){let n=o.$implicit;l(2),v(n.description),l(2),v(n.prixTotal),l(2),p(" ",y(7,4,n.prixUnitaire,"CFA")," "),l(3),p(" ",y(10,7,n.prixTotal*n.prixUnitaire,"CFA")," ")}}function gt(a,o){a&1&&(t(0,"tr")(1,"td",121),i(2," Aucun d\xE9tail disponible "),e()())}function _t(a,o){a&1&&(t(0,"p",105),i(1," Remise: "),e())}function ht(a,o){if(a&1&&(t(0,"p",122),i(1),E(2,"currency"),e()),a&2){let n=f(2);l(),p(" -",y(2,1,n.selectedDevis.remise,"CFA")," ")}}function bt(a,o){if(a&1&&(t(0,"div",123)(1,"h6",104),i(2,"Notes"),e(),t(3,"p"),i(4),e()()),a&2){let n=f(2);l(4),v(n.selectedDevis.notes)}}function Et(a,o){if(a&1&&(t(0,"div",102)(1,"div",16)(2,"div",103)(3,"h6",104),i(4,"Informations g\xE9n\xE9rales"),e(),t(5,"div",48)(6,"p",105)(7,"strong"),i(8,"Projet:"),e(),i(9),e(),t(10,"p",105)(11,"strong"),i(12,"R\xE9f\xE9rence:"),e(),i(13),e(),t(14,"p",105)(15,"strong"),i(16,"\xC9tat:"),e(),t(17,"span",106),i(18),E(19,"titlecase"),e()()()(),t(20,"div",103)(21,"h6",104),i(22,"Dates"),e(),t(23,"div",48)(24,"p",105)(25,"strong"),i(26,"\xC9mission:"),e(),i(27),E(28,"date"),e(),t(29,"p",105)(30,"strong"),i(31,"\xC9ch\xE9ance:"),e(),i(32),E(33,"date"),e(),_(34,ut,5,4,"p",107),e()(),t(35,"div",96)(36,"h6",108),i(37,"Client"),e(),t(38,"div",48)(39,"p",105)(40,"strong"),i(41,"ID:"),e(),i(42),e(),_(43,vt,4,1,"p",107)(44,ft,4,1,"p",107),e()(),t(45,"div",96)(46,"h6",108),i(47,"D\xE9tails des prestations"),e(),t(48,"div",109)(49,"table",110)(50,"thead")(51,"tr")(52,"th"),i(53,"Description"),e(),t(54,"th",111),i(55,"Quantit\xE9"),e(),t(56,"th",111),i(57,"Prix unitaire"),e(),t(58,"th",111),i(59,"Total"),e()()(),t(60,"tbody"),_(61,xt,11,10,"tr",112)(62,gt,3,0,"tr",113),e()()()(),t(63,"div",96)(64,"h6",108),i(65,"R\xE9sum\xE9 financier"),e(),t(66,"div",114)(67,"div",115)(68,"div",16)(69,"div",116)(70,"p",105),i(71,"Prix HT:"),e(),t(72,"p",105),i(73),e(),_(74,_t,2,0,"p",107),t(75,"p",117),i(76,"Total TTC:"),e()(),t(77,"div",118)(78,"p",105),i(79),E(80,"currency"),e(),t(81,"p",105),i(82),E(83,"currency"),e(),_(84,ht,3,4,"p",119),t(85,"p",117),i(86),E(87,"currency"),e()()()()()(),_(88,bt,5,1,"div",120),e()()),a&2){let n=f();l(9),p(" ",n.selectedDevis.nomProjet," "),l(4),p(" ",n.selectedDevis.reference," "),l(4),c("ngClass",J(36,it,n.selectedDevis.statut==="brouillon",n.selectedDevis.statut==="envoye",n.selectedDevis.statut==="accepte",n.selectedDevis.statut==="refuse")),l(),v(Ee(19,19,n.selectedDevis.statut)),l(9),p(" ",y(28,21,n.selectedDevis.dateEmission,"dd/MM/yyyy")," "),l(5),p(" ",y(33,24,n.selectedDevis.dateEcheance,"dd/MM/yyyy")," "),l(2),c("ngIf",n.selectedDevis.dateEmission),l(8),p(" ",n.selectedDevis.clientTrackingId," "),l(),c("ngIf",n.selectedDevis.clientName),l(),c("ngIf",n.selectedDevis.clientEmail),l(17),c("ngForOf",n.selectedDevis.prestations||L(41,nt)),l(),c("ngIf",!n.selectedDevis.prestations||n.selectedDevis.prestations.length===0),l(11),p("TVA (",n.selectedDevis.tva,"%):"),l(),c("ngIf",n.selectedDevis.remise>0),l(5),p(" ",y(80,27,n.selectedDevis.prixTotal,"CFA")," "),l(3),p(" ",y(83,30,n.selectedDevis.prixTotal*n.selectedDevis.tva/100,"CFA")," "),l(2),c("ngIf",n.selectedDevis.remise>0),l(2),p(" ",y(87,33,n.selectedDevis.prixTTC,"CFA")," "),l(2),c("ngIf",n.selectedDevis.notes)}}function Ct(a,o){if(a&1){let n=S();t(0,"button",124),x("click",function(){h(n);let s=f();return b(s.convertToFacture(s.selectedDevis))}),m(1,"i",125),i(2,"Convertir en facture "),e()}}function yt(a,o){if(a&1){let n=S();t(0,"button",126),x("click",function(){h(n);let s=f();return b(s.downloadDevis(s.selectedDevis))}),m(1,"i",127),i(2,"T\xE9l\xE9charger "),e()}}var ue=class a{constructor(o,n,r){this.devisService=o;this.factureService=n;this.router=r}devis=[];isLoading=!1;errorMessage=null;activeFilter="tous";searchTerm="";filteredDevis=[];selectedDevis=null;ngOnInit(){this.loadDevis()}loadDevis(){this.isLoading=!0,this.devisService.findByCreatedBy().subscribe({next:o=>{this.devis=o.data,this.applyFilters(),this.isLoading=!1},error:o=>{this.errorMessage="Erreur lors du chargement des devis",this.isLoading=!1,console.error("Erreur:",o)}})}applyFilters(){let o=this.devis;if(this.activeFilter!=="tous"&&(o=this.devis.filter(n=>n.statut===this.activeFilter)),this.searchTerm&&this.searchTerm.trim()!==""){let n=this.searchTerm.toLowerCase().trim();o=o.filter(r=>r.nomProjet.toLowerCase().includes(n)||r.reference.toLowerCase().includes(n)||r.clientName&&r.clientName.toLowerCase().includes(n))}this.filteredDevis=o}filterDevis(o){this.activeFilter=o,this.applyFilters()}convertToFacture(o){if(o.statut!=="ACCEPTE"){P.default.fire({icon:"warning",title:"Attention",text:"Seuls les devis accept\xE9s peuvent \xEAtre convertis en facture"});return}P.default.fire({title:"Confirmation",text:`\xCAtes-vous s\xFBr de vouloir convertir le devis ${o.reference} en facture ?`,icon:"question",showCancelButton:!0,confirmButtonText:"Oui, convertir",cancelButtonText:"Non, annuler",confirmButtonColor:"#3085d6",cancelButtonColor:"#d33"}).then(n=>{n.isConfirmed&&this.factureService.createFromDevis(o.trackingId).subscribe({next:r=>{P.default.fire({icon:"success",title:"Succ\xE8s",text:"Devis converti en facture avec succ\xE8s",timer:2e3,showConfirmButton:!1}).then(()=>{this.router.navigate(["/dashboard/factures"])})},error:r=>{P.default.fire({icon:"error",title:"Erreur",text:"Erreur lors de la conversion en facture"}),console.error("Erreur de conversion:",r)}})})}updateDevisStatus(o){let n=o.statut;this.devisService.updateDevisStatus(o.trackingId,o.statut).subscribe({next:()=>{P.default.fire({icon:"success",title:"Succ\xE8s",text:`Statut du devis ${o.reference} mis \xE0 jour avec succ\xE8s`,timer:2e3,showConfirmButton:!1}),this.loadDevis()},error:r=>{o.statut=n,P.default.fire({icon:"error",title:"Erreur",text:`Erreur lors de la mise \xE0 jour du statut: ${r.error?.message||"Erreur inconnue"}`}),console.error("Erreur de mise \xE0 jour du statut:",r)}})}downloadDevis(o){this.devisService.downloadDevisPDF(o.trackingId).subscribe({next:n=>{let r=window.URL.createObjectURL(n),s=document.createElement("a");s.href=r,s.download=`Devis_${o.reference}.pdf`,document.body.appendChild(s),s.click(),document.body.removeChild(s),window.URL.revokeObjectURL(r)},error:n=>{P.default.fire({icon:"error",title:"Erreur",text:"Erreur lors du t\xE9l\xE9chargement du PDF"}),console.error("Erreur de t\xE9l\xE9chargement:",n)}})}deleteDevis(o){P.default.fire({title:"\xCAtes-vous s\xFBr ?",text:`Voulez-vous vraiment supprimer le devis ${o.reference} ?`,icon:"warning",showCancelButton:!0,confirmButtonText:"Oui, supprimer",cancelButtonText:"Non, annuler",confirmButtonColor:"#d33",cancelButtonColor:"#3085d6"}).then(n=>{n.isConfirmed&&(this.isLoading=!0,this.devisService.deleteDevis(o.trackingId).subscribe({next:r=>{P.default.fire({icon:"success",title:"Supprim\xE9 !",text:`Le devis ${o.reference} a \xE9t\xE9 supprim\xE9 avec succ\xE8s`,timer:2e3,showConfirmButton:!1}),this.loadDevis()},error:r=>{this.isLoading=!1,P.default.fire({icon:"error",title:"Erreur",text:`Erreur lors de la suppression du devis: ${r.error?.message||"Erreur inconnue"}`}),console.error("Erreur de suppression:",r)}}))})}openDetailsModal(o){this.selectedDevis=o}addDevis(){this.router.navigate(["add-devis"])}editDevis(o){this.router.navigate(["edit-devis",o])}static \u0275fac=function(n){return new(n||a)(C(Y),C(je),C(W))};static \u0275cmp=M({type:a,selectors:[["app-list-devis"]],standalone:!1,decls:48,vars:15,consts:[[1,"pc-container"],[1,"pc-content"],[1,"page-header","mb-4"],[1,"page-block"],[1,"row","align-items-center"],[1,"col-md-12"],["aria-label","breadcrumb"],[1,"breadcrumb","m-0"],[1,"breadcrumb-item"],[1,"text-decoration-none",3,"routerLink"],[1,"ti","ti-home","me-1"],["aria-current","page",1,"breadcrumb-item","active"],[1,"col-md-12","mt-3","d-flex","justify-content-between","align-items-center"],[1,"mb-0","fw-bold"],[1,"btn","btn-primary","d-flex","align-items-center",3,"routerLink"],[1,"ti","ti-plus","me-2"],[1,"row"],[1,"col-sm-12"],[1,"card","shadow-sm"],[1,"card-header","bg-light","d-flex","justify-content-between","align-items-center","py-3"],[1,"mb-0"],[1,"ti","ti-file-invoice","me-2"],[1,"card-body","p-0"],["class","text-center p-5",4,"ngIf"],["class","p-4",4,"ngIf"],["class","p-4 border-bottom",4,"ngIf"],["id","devisDetailsModal","tabindex","-1",1,"modal","fade"],[1,"modal-dialog","modal-lg"],[1,"modal-content"],[1,"modal-header"],["class","modal-title",4,"ngIf"],["type","button","data-bs-dismiss","modal",1,"btn-close"],["class","modal-body",4,"ngIf"],[1,"modal-footer"],["class","btn btn-success","data-bs-dismiss","modal",3,"click",4,"ngIf"],["data-bs-dismiss","modal",1,"btn","btn-outline-primary",3,"routerLink"],[1,"bx","bx-pencil","me-2"],["class","btn btn-outline-secondary","data-bs-dismiss","modal",3,"click",4,"ngIf"],["type","button","data-bs-dismiss","modal",1,"btn","btn-secondary"],[1,"text-center","p-5"],["role","status",1,"spinner-border","text-primary"],[1,"visually-hidden"],[1,"mt-3","mb-0"],[1,"p-4"],[1,"alert","alert-danger","d-flex","align-items-center","mb-0"],[1,"ti","ti-alert-circle","me-2","fs-5"],[1,"text-muted","mb-3"],[1,"ti","ti-file-off",2,"font-size","3rem"],[1,"mb-3"],[1,"btn","btn-primary",3,"routerLink"],[1,"p-4","border-bottom"],[1,"row","g-3"],[1,"col-md-4"],[1,"input-group"],[1,"input-group-text"],[1,"ti","ti-search"],["type","text","placeholder","Rechercher un devis...",1,"form-control",3,"ngModelChange","ngModel"],[1,"col-md-8"],[1,"d-flex","flex-wrap","gap-2","justify-content-md-end"],["role","group",1,"btn-group"],["type","button",1,"btn",3,"click","ngClass"],["class","col-md-6 col-lg-4",4,"ngFor","ngForOf"],[1,"col-md-6","col-lg-4"],[1,"card","shadow-sm","h-100"],[1,"card-header","p-3",3,"ngClass"],[1,"d-flex","justify-content-between","align-items-center"],[1,"badge",3,"ngClass"],[1,"ti",3,"ngClass"],[1,"form-select","form-select-sm",3,"ngModelChange","change","click","ngModel"],["value","BROUILLON"],["value","ENVOYE"],["value","ACCEPTE"],["value","REFUSE"],[1,"card-body","p-3","cursor-pointer",3,"click"],[1,"card-title","mb-3","fw-bold","text-truncate"],[1,"d-flex","align-items-center","mb-2"],[1,"ti","ti-file-invoice","me-2","text-primary"],[1,"text-muted"],[1,"ms-1","fw-medium"],[1,"ti","ti-user","me-2","text-primary"],[1,"ms-1","fw-medium","text-truncate"],[1,"ti","ti-calendar","me-2","text-primary"],[1,"d-flex","align-items-center"],[1,"ti","ti-coin","me-2","text-primary"],[1,"ms-1","fw-bold"],[1,"card-footer","p-3","bg-light","d-flex","justify-content-between"],["title","Modifier",1,"btn","btn-sm","btn-outline-secondary","me-1",3,"click","routerLink"],[1,"ti","ti-edit"],["title","Supprimer",1,"btn","btn-sm","btn-outline-danger",3,"click"],[1,"ti","ti-trash"],["title","T\xE9l\xE9charger",1,"btn","btn-sm","btn-outline-primary","me-1",3,"click"],[1,"ti","ti-download"],["class","btn btn-sm btn-success","title","Transformer en facture",3,"click",4,"ngIf"],["class","col-12",4,"ngIf"],["title","Transformer en facture",1,"btn","btn-sm","btn-success",3,"click"],[1,"ti","ti-file-invoice"],[1,"col-12"],[1,"empty-state"],[1,"empty-icon"],[1,"bx","bx-file-x","fs-1"],[1,"bx","bx-plus","me-2"],[1,"modal-title"],[1,"modal-body"],[1,"col-md-6"],[1,"border-bottom","pb-2"],[1,"mb-1"],[3,"ngClass"],["class","mb-1",4,"ngIf"],[1,"border-bottom","pb-2","mt-2"],[1,"table-responsive"],[1,"table","table-sm"],[1,"text-end"],[4,"ngFor","ngForOf"],[4,"ngIf"],[1,"card","bg-light"],[1,"card-body"],[1,"col-6"],[1,"fw-bold","mb-0"],[1,"col-6","text-end"],["class","mb-1 text-danger",4,"ngIf"],["class","col-12 mt-3",4,"ngIf"],["colspan","4",1,"text-center"],[1,"mb-1","text-danger"],[1,"col-12","mt-3"],["data-bs-dismiss","modal",1,"btn","btn-success",3,"click"],[1,"bx","bx-file","me-2"],["data-bs-dismiss","modal",1,"btn","btn-outline-secondary",3,"click"],[1,"bx","bx-download","me-2"]],template:function(n,r){n&1&&(t(0,"div",0)(1,"div",1)(2,"div",2)(3,"div",3)(4,"div",4)(5,"div",5)(6,"nav",6)(7,"ol",7)(8,"li",8)(9,"a",9),m(10,"i",10),i(11,"Tableau de Bord "),e()(),t(12,"li",11),i(13,"Devis"),e()()()(),t(14,"div",12)(15,"h2",13),i(16,"Gestion des Devis"),e(),t(17,"div")(18,"button",14),m(19,"i",15),i(20,"Nouveau devis "),e()()()()()(),t(21,"div",16)(22,"div",17)(23,"div",18)(24,"div",19)(25,"h5",20),m(26,"i",21),i(27,"Liste des devis"),e()(),t(28,"div",22),_(29,rt,6,0,"div",23)(30,ot,5,1,"div",24)(31,lt,10,2,"div",23)(32,ct,21,22,"div",25),e(),t(33,"div",26)(34,"div",27)(35,"div",28)(36,"div",29),_(37,pt,2,1,"h5",30),m(38,"button",31),e(),_(39,Et,89,42,"div",32),t(40,"div",33),_(41,Ct,3,0,"button",34),t(42,"button",35),m(43,"i",36),i(44,"Modifier "),e(),_(45,yt,3,0,"button",37),t(46,"button",38),i(47," Fermer "),e()()()()()()()()()()),n&2&&(l(9),c("routerLink",L(11,Je)),l(9),c("routerLink",L(12,Se)),l(11),c("ngIf",r.isLoading),l(),c("ngIf",r.errorMessage&&!r.isLoading),l(),c("ngIf",!r.isLoading&&!r.errorMessage&&(!r.devis||r.devis.length===0)),l(),c("ngIf",!r.isLoading&&!r.errorMessage&&r.devis&&r.devis.length>0),l(5),c("ngIf",r.selectedDevis),l(2),c("ngIf",r.selectedDevis),l(2),c("ngIf",(r.selectedDevis==null?null:r.selectedDevis.statut)==="ACCEPTE"),l(),c("routerLink",be(13,Ke,r.selectedDevis==null?null:r.selectedDevis.trackingId)),l(3),c("ngIf",r.selectedDevis))},dependencies:[we,N,R,Re,H,z,B,G,q,$,Me,Fe,V],styles:[".file-card[_ngcontent-%COMP%]{position:relative;height:220px;border-radius:8px;overflow:hidden;transition:all .2s ease;box-shadow:0 2px 8px #00000014;margin-bottom:10px;background-color:#fff}.file-card[_ngcontent-%COMP%]:hover{box-shadow:0 4px 12px #00000026;transform:translateY(-2px)}.file-card[_ngcontent-%COMP%]:hover   .file-actions[_ngcontent-%COMP%]{opacity:1}.file-header[_ngcontent-%COMP%]{height:40px;display:flex;align-items:center;justify-content:space-between;padding:0 15px;border-bottom:1px solid rgba(0,0,0,.05)}.file-header[_ngcontent-%COMP%]   .file-icon[_ngcontent-%COMP%]{color:#555}.file-header[_ngcontent-%COMP%]   .status-dropdown[_ngcontent-%COMP%]{font-size:12px;padding:2px 6px;height:auto;border-radius:4px;width:auto;min-width:100px;background-color:#fffc}.file-header[_ngcontent-%COMP%]   .status-dropdown[_ngcontent-%COMP%]:focus{box-shadow:none;border-color:#dee2e6}.file-body[_ngcontent-%COMP%]{height:140px;padding:15px;cursor:pointer;position:relative;overflow:hidden}.file-body[_ngcontent-%COMP%]   .file-content[_ngcontent-%COMP%]{position:relative;z-index:2}.file-body[_ngcontent-%COMP%]   .file-lines[_ngcontent-%COMP%]{position:absolute;top:0;left:0;width:100%;height:100%;z-index:1;padding:15px;opacity:.2}.file-body[_ngcontent-%COMP%]   .file-lines[_ngcontent-%COMP%]   .file-line[_ngcontent-%COMP%]{height:4px;background-color:#e9ecef;margin:12px 0;width:100%;border-radius:2px}.file-body[_ngcontent-%COMP%]   .file-lines[_ngcontent-%COMP%]   .file-line[_ngcontent-%COMP%]:nth-child(2){width:85%}.file-body[_ngcontent-%COMP%]   .file-lines[_ngcontent-%COMP%]   .file-line[_ngcontent-%COMP%]:nth-child(3){width:70%}.file-body[_ngcontent-%COMP%]   .file-lines[_ngcontent-%COMP%]   .file-line[_ngcontent-%COMP%]:nth-child(4){width:60%}.file-title[_ngcontent-%COMP%]{font-weight:600;margin-bottom:5px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}.file-ref[_ngcontent-%COMP%]{color:#6c757d;font-size:13px;margin-bottom:5px}.file-client[_ngcontent-%COMP%]{color:#495057;font-size:13px;margin-bottom:5px}.file-footer[_ngcontent-%COMP%]{margin-top:10px;display:flex;justify-content:space-between;align-items:center}.file-footer[_ngcontent-%COMP%]   .file-date[_ngcontent-%COMP%]{font-size:12px;color:#6c757d}.file-footer[_ngcontent-%COMP%]   .file-price[_ngcontent-%COMP%]{font-size:13px;font-weight:600;color:#198754}.file-actions[_ngcontent-%COMP%]{position:absolute;bottom:0;left:0;right:0;display:flex;justify-content:space-around;background-color:#ffffffe6;padding:5px;opacity:0;transition:opacity .2s ease;border-top:1px solid rgba(0,0,0,.05);height:40px}.file-actions[_ngcontent-%COMP%]   button[_ngcontent-%COMP%]{border:none;background-color:transparent;width:30px;height:30px;padding:0;display:flex;align-items:center;justify-content:center;color:#495057;border-radius:4px}.file-actions[_ngcontent-%COMP%]   button[_ngcontent-%COMP%]:hover{background-color:#f8f9fa;color:#0d6efd}.file-actions[_ngcontent-%COMP%]   button[_ngcontent-%COMP%]:disabled{color:#adb5bd;cursor:not-allowed}.file-actions[_ngcontent-%COMP%]   button.btn-primary[_ngcontent-%COMP%]{background-color:#0d6efd!important;color:#fff!important;border:none;min-width:70px;padding:0 10px;display:flex;align-items:center;justify-content:center}.file-actions[_ngcontent-%COMP%]   button.btn-primary[_ngcontent-%COMP%]:hover{background-color:#0b5ed7!important;color:#fff!important}.empty-state[_ngcontent-%COMP%]{text-align:center;padding:60px 0}.empty-state[_ngcontent-%COMP%]   .empty-icon[_ngcontent-%COMP%]{font-size:48px;color:#adb5bd;margin-bottom:15px}.empty-state[_ngcontent-%COMP%]   h4[_ngcontent-%COMP%]{margin-bottom:10px}.empty-state[_ngcontent-%COMP%]   p[_ngcontent-%COMP%]{margin-bottom:20px}.btn-group[_ngcontent-%COMP%]   .btn[_ngcontent-%COMP%]{transition:all .2s ease}"]})};function Pt(a,o){if(a&1){let n=S();t(0,"tr",96)(1,"td"),i(2),e(),t(3,"td"),m(4,"input",97),e(),t(5,"td"),m(6,"input",98),e(),t(7,"td")(8,"input",99),x("input",function(){let s=h(n).index,u=f();return b(u.updatePrestationTotal(s))}),e()(),t(9,"td")(10,"input",100),x("input",function(){let s=h(n).index,u=f();return b(u.updatePrestationTotal(s))}),e()(),t(11,"td"),m(12,"input",101),e(),t(13,"td")(14,"button",102),x("click",function(){let s=h(n).index,u=f();return b(u.removePrestation(s))}),m(15,"i",103),e()()()}if(a&2){let n=o.index;c("formGroupName",n),l(2),v(n+1)}}function It(a,o){a&1&&m(0,"span",104)}function wt(a,o){if(a&1&&m(0,"img",115),a&2){let n=f(2);c("src",n.previewUrl,Q)}}function Mt(a,o){if(a&1&&(t(0,"div",117),i(1),e()),a&2){let n=f().$implicit;l(),v(n.description)}}function Ft(a,o){if(a&1&&(t(0,"tr")(1,"td"),i(2),_(3,Mt,2,1,"div",116),e(),t(4,"td",90),i(5),e(),t(6,"td",90),i(7),e(),t(8,"td",90),i(9),e()()),a&2){let n=o.$implicit;l(2),p(" ",n.designation," "),l(),c("ngIf",n.description),l(2),p("",n.prixUnitaire," CFA"),l(2),v(n.duree),l(2),p("",n.prixTotal," CFA")}}function At(a,o){if(a&1&&(t(0,"div")(1,"h6"),i(2,"Notes"),e(),t(3,"p"),i(4),e()()),a&2){let n,r=f(2);l(4),v((n=r.devisForm.get("notes"))==null?null:n.value)}}function kt(a,o){if(a&1){let n=S();t(0,"div",3)(1,"div",4)(2,"div",105)(3,"h5",6),i(4,"Aper\xE7u"),e(),t(5,"button",106),x("click",function(){h(n);let s=f();return b(s.showPreview=!1)}),e()(),t(6,"div",107)(7,"div",108)(8,"div")(9,"h4"),i(10),e(),t(11,"p",75),i(12),e(),t(13,"p",75),i(14),e(),t(15,"p"),i(16),e()(),t(17,"div"),_(18,wt,1,1,"img",76),e()(),t(19,"div",109)(20,"h2"),i(21),e(),t(22,"p"),i(23),e()(),t(24,"div",9)(25,"div",41)(26,"p")(27,"strong"),i(28,"Date:"),e(),i(29),E(30,"date"),e()(),t(31,"div",42)(32,"p")(33,"strong"),i(34,"\xC9ch\xE9ance:"),e(),i(35),E(36,"date"),e()()(),t(37,"div",110)(38,"h5"),i(39,"Client"),e(),t(40,"p",75),i(41),e(),t(42,"p",75),i(43),e(),t(44,"p",75),i(45),e(),t(46,"p"),i(47),e()(),t(48,"div",29)(49,"table",89)(50,"thead")(51,"tr")(52,"th"),i(53,"D\xE9signation"),e(),t(54,"th",90),i(55,"PU"),e(),t(56,"th",90),i(57,"Qt\xE9"),e(),t(58,"th",90),i(59,"Total"),e()()(),t(60,"tbody"),_(61,Ft,10,5,"tr",65),e()()(),t(62,"div",111)(63,"div",41)(64,"div",112)(65,"span"),i(66,"Total HT:"),e(),t(67,"span"),i(68),e()(),t(69,"div",112)(70,"span"),i(71),e(),t(72,"span"),i(73),e()(),t(74,"div",112)(75,"span"),i(76),e(),t(77,"span"),i(78),e()(),m(79,"hr"),t(80,"div",113)(81,"span"),i(82,"Total TTC:"),e(),t(83,"span"),i(84),e()()()(),_(85,At,5,1,"div",114),e()()()}if(a&2){let n,r,s,u,T,I,w,d=f();l(10),v((d.companyProfile==null?null:d.companyProfile.companyName)||"Votre Entreprise"),l(2),v(d.companyProfile==null?null:d.companyProfile.address),l(2),D("",d.companyProfile==null?null:d.companyProfile.postalCode," ",d.companyProfile==null?null:d.companyProfile.city,""),l(2),D("",d.companyProfile==null?null:d.companyProfile.email," | ",d.companyProfile==null?null:d.companyProfile.phoneNumber,""),l(2),c("ngIf",d.companyProfile==null?null:d.companyProfile.hasLogo),l(3),p("Devis ",(n=d.devisForm.get("reference"))==null?null:n.value,""),l(2),p("Projet: ",(r=d.devisForm.get("nomProjet"))==null?null:r.value,""),l(6),p(" ",y(30,24,(s=d.devisForm.get("dateEmission"))==null?null:s.value,"dd/MM/yyyy"),""),l(6),p(" ",y(36,27,(u=d.devisForm.get("dateEcheance"))==null?null:u.value,"dd/MM/yyyy"),""),l(6),v(d.selectedClient==null?null:d.selectedClient.nom),l(2),v(d.selectedClient==null?null:d.selectedClient.societe),l(2),v(d.selectedClient==null?null:d.selectedClient.adresse),l(2),D("",d.selectedClient==null?null:d.selectedClient.email," | ",d.selectedClient==null?null:d.selectedClient.telephone,""),l(14),c("ngForOf",d.prestationsArray.value),l(7),p("",d.totalHT," CFA"),l(3),p("TVA (",(T=d.devisForm.get("tva"))==null?null:T.value,"%):"),l(2),p("",d.montantTVA," CFA"),l(3),p("Remise (",(I=d.devisForm.get("remise"))==null?null:I.value,"%):"),l(2),p("-",d.montantRemise," CFA"),l(6),p("",d.totalTTC," CFA"),l(),c("ngIf",(w=d.devisForm.get("notes"))==null?null:w.value)}}function Lt(a,o){if(a&1){let n=S();t(0,"tr")(1,"td"),i(2),e(),t(3,"td"),i(4),e(),t(5,"td"),i(6),e(),t(7,"td")(8,"button",118),x("click",function(){let s=h(n).$implicit,u=f();return b(u.selectClient(s))}),i(9," S\xE9lectionner "),e()()()}if(a&2){let n=o.$implicit;l(2),v(n.nom),l(2),v(n.societe),l(2),v(n.email)}}function Ot(a,o){if(a&1){let n=S();t(0,"tr")(1,"td"),i(2),e(),t(3,"td"),i(4),e(),t(5,"td"),i(6),e(),t(7,"td")(8,"div",119)(9,"input",120),x("change",function(){let s=h(n).$implicit,u=f();return b(u.togglePrestationSelection(s))}),e()()()()}if(a&2){let n=o.$implicit,r=f();l(2),v(n.designation),l(2),v(n.description),l(2),p("",n.prixUnitaire," CFA"),l(3),c("checked",r.isPrestationSelected(n))}}function Nt(a,o){if(a&1&&m(0,"img",115),a&2){let n=f();c("src",n.previewUrl,Q)}}function Rt(a,o){if(a&1&&(t(0,"tr")(1,"td"),i(2),e(),t(3,"td"),i(4),e(),t(5,"td"),i(6),e(),t(7,"td",90),i(8),e(),t(9,"td",90),i(10),e(),t(11,"td",90),i(12),e()()),a&2){let n=o.$implicit,r=o.index;l(2),v(r+1),l(2),v(n.designation),l(2),v(n.description),l(2),p("",n.prixUnitaire," CFA"),l(2),v(n.duree),l(2),p("",n.prixTotal," CFA")}}var ve=class a{constructor(o,n,r,s,u,T){this.fb=o;this.devisService=n;this.clientsService=r;this.prestationsService=s;this.companyProfileService=u;this.router=T;this.devisForm=this.fb.group({reference:["",g.required],nomProjet:["",g.required],description:[""],client:[null,g.required],dateEmission:[new Date,g.required],dateEcheance:[this.addDays(new Date,30),g.required],prixTotal:[0,g.required],prixTTC:[0,g.required],tva:[20,g.required],remise:[0,g.required],statut:["BROUILLON",g.required],notes:[""],prestations:this.fb.array([])}),console.log("Formulaire initialis\xE9:",this.devisForm.value)}devisForm;clients=[];filteredClients=[];prestations=[];filteredPrestations=[];selectedClient=null;companyProfile=null;previewUrl=null;today=new Date().toISOString().split("T")[0];todayPlusOneMonth=(()=>{let o=new Date;return o.setMonth(o.getMonth()+1),o.toISOString().split("T")[0]})();loading=!1;showPreview=!1;searchTermClient="";searchTermPrestation="";totalHT=0;montantTVA=0;montantRemise=0;totalTTC=0;clientModal;prestationModal;previewModal;errorMessage="";selectedPrestations=[];ngOnInit(){console.log("ngOnInit AddDevisComponent"),this.loadClients(),this.loadPrestations(),this.loadCompanyProfile(),this.initModals(),console.log("Formulaire apr\xE8s init (avant r\xE9f\xE9rence):",this.devisForm.value);let o=new Date,n=`DEV-${o.getFullYear()}${(o.getMonth()+1).toString().padStart(2,"0")}-${this.generateRandomReference()}`;console.log("R\xE9f\xE9rence g\xE9n\xE9r\xE9e:",n),this.devisForm.patchValue({reference:n})}loadCompanyProfile(){console.log("Chargement du profil..."),this.loading=!0,this.companyProfileService.getProfile().pipe(he(o=>(console.error("Erreur lors du chargement du profil:",o),o.status!==404&&(this.errorMessage="Erreur lors du chargement du profil"),_e(null))),Pe(()=>{this.loading=!1,console.log("Fin du chargement du profil")})).subscribe(o=>{console.log("Profil r\xE9cup\xE9r\xE9:",o),o&&(this.companyProfile=o,o.trackingId&&o.hasLogo?(console.log("Le profil a un logo, mise \xE0 jour de l'URL de pr\xE9visualisation"),this.updatePreviewUrl(o.trackingId)):console.log("Le profil n'a pas de logo ou pas de trackingId:",o))})}updatePreviewUrl(o){this.companyProfileService.getLogoImage(o).pipe(he(n=>(console.error("Erreur lors du chargement du logo:",n),_e(null)))).subscribe(n=>{n&&(this.previewUrl=URL.createObjectURL(n),console.log("Preview logo URL (cache bust):",this.previewUrl))})}initModals(){setTimeout(()=>{this.clientModal=new bootstrap.Modal(document.getElementById("clientModal")),this.prestationModal=new bootstrap.Modal(document.getElementById("prestationModal")),this.previewModal=new bootstrap.Modal(document.getElementById("previewModal")),console.log("Modals initialis\xE9s:",{clientModal:this.clientModal,prestationModal:this.prestationModal,previewModal:this.previewModal})},500)}loadClients(){this.clientsService.getClients().subscribe(o=>{this.clients=o||[],this.filteredClients=[...this.clients],console.log("Clients charg\xE9s:",this.clients)},o=>console.error("Erreur lors du chargement des clients:",o))}loadPrestations(){this.prestationsService.findByCreatedBy().subscribe(o=>{this.prestations=o||[],this.filteredPrestations=[...this.prestations],console.log("Prestations charg\xE9es:",this.prestations)},o=>console.error("Erreur lors du chargement des prestations:",o))}get prestationsArray(){let o=this.devisForm.get("prestations");return console.log("Acc\xE8s au FormArray des prestations:",o.value),o}addEmptyPrestation(){let o=this.fb.group({designation:["",g.required],description:[""],prixUnitaire:[0,[g.required,g.min(0)]],duree:[1,[g.required,g.min(.1)]],prixTotal:[0,g.required]});this.prestationsArray.push(o),console.log("Ajout d'une prestation vide, index:",this.prestationsArray.length-1,this.prestationsArray.value)}removePrestation(o){this.prestationsArray.removeAt(o),console.log("Suppression prestation index:",o,"prestations restantes:",this.prestationsArray.value),this.updateTotals()}updatePrestationTotal(o){let n=this.prestationsArray.at(o),r=n.get("prixUnitaire")?.value||0,s=n.get("duree")?.value||0,u=r*s;n.patchValue({prixTotal:u}),console.log(`Mise \xE0 jour prestation ${o}, prixUnitaire: ${r},`,`dur\xE9e: ${s}, total: ${u}`),this.updateTotals()}openClientModal(){this.searchTermClient="",this.filteredClients=[...this.clients],console.log("Ouverture modal clients, clients disponibles:",this.filteredClients.length),this.clientModal.show()}openPrestationModal(){this.searchTermPrestation="",this.filteredPrestations=[...this.prestations],console.log("Ouverture modal prestations, prestations disponibles:",this.filteredPrestations.length),this.prestationModal.show()}filterClients(){let o=this.searchTermClient.toLowerCase();this.filteredClients=this.clients.filter(n=>n.nom.toLowerCase().includes(o)||n.email.toLowerCase().includes(o)||n.societe&&n.societe.toLowerCase().includes(o)),console.log(`Recherche client "${o}", r\xE9sultats:`,this.filteredClients)}filterPrestations(){let o=this.searchTermPrestation.toLowerCase();this.filteredPrestations=this.prestations.filter(n=>n.designation.toLowerCase().includes(o)||n.description&&n.description.toLowerCase().includes(o)),console.log(`Recherche prestation "${o}", r\xE9sultats:`,this.filteredPrestations)}previewDevis(){this.showPreview=!0,console.log("Aper\xE7u du devis g\xE9n\xE9r\xE9:",this.devisForm.value),this.previewModal.show()}exportToPDF(){console.log("Export PDF demand\xE9 pour le devis:",this.devisForm.value),alert("Fonctionnalit\xE9 d'export en PDF \xE0 impl\xE9menter")}onSubmit(){if(this.devisForm.invalid||!this.selectedClient){this.selectedClient||(this.devisForm.get("client")?.markAsTouched(),this.errorMessage="Veuillez s\xE9lectionner un client");return}this.loading=!0;let o=this.devisForm.value,n=o.prestations.filter(s=>s.trackingId).map(s=>({trackingId:s.trackingId,designation:s.designation,description:s.description,prixUnitaire:s.prixUnitaire,duree:s.duree,prixTotal:s.prixTotal})),r={reference:o.reference,nomProjet:o.nomProjet,description:o.description,client:this.selectedClient,dateEmission:o.dateEmission,dateEcheance:o.dateEcheance,prixTotal:o.prixTotal,prixTTC:o.prixTTC,tva:o.tva,remise:o.remise,statut:o.statut,notes:o.notes,prestations:n};console.log("Requ\xEAte de cr\xE9ation du devis avec prestations (incluant trackingId):",r),this.devisService.create(r).subscribe(s=>{this.loading=!1,console.log("Devis cr\xE9\xE9 avec succ\xE8s:",s),alert("Devis cr\xE9\xE9 avec succ\xE8s!"),this.router.navigate(["/dashboard/devis"])},s=>{this.loading=!1,console.error("Erreur lors de la cr\xE9ation du devis:",s),alert("Une erreur est survenue lors de la cr\xE9ation du devis: "+(s.error?.message||"Erreur inconnue"))})}addDays(o,n){let r=new Date(o);return r.setDate(r.getDate()+n),console.log(`addDays: date initiale ${o}, jours ajout\xE9s ${n}, r\xE9sultat ${r}`),r}generateRandomReference(){let o=Math.floor(100+Math.random()*900).toString();return console.log("generateRandomReference:",o),o}selectClient(o){this.selectedClient=o,this.devisForm.get("client")?.setValue(o),this.devisForm.get("client")?.updateValueAndValidity(),console.log("Client s\xE9lectionn\xE9 et formulaire mis \xE0 jour:",o,this.devisForm.value),this.clientModal.hide()}selectPrestation(o){let n=o.trackingId||this.generateTrackingId(),r=this.fb.group({trackingId:[n,g.required],designation:[o.designation,g.required],description:[o.description||""],prixUnitaire:[o.prixUnitaire,[g.required,g.min(0)]],duree:[1,[g.required,g.min(.1)]],prixTotal:[o.prixUnitaire,g.required]});this.prestationsArray.push(r),this.updateTotals(),console.log("Prestation s\xE9lectionn\xE9e ajout\xE9e:",o,"index:",this.prestationsArray.length-1)}generateTrackingId(){return Math.random().toString(36).substring(2,15)+Math.random().toString(36).substring(2,15)}isPrestationSelected(o){return this.selectedPrestations.some(n=>n.trackingId===o.trackingId)}togglePrestationSelection(o){let n=this.selectedPrestations.findIndex(r=>r.trackingId===o.trackingId);n===-1?this.selectedPrestations.push(o):this.selectedPrestations.splice(n,1)}addSelectedPrestations(){this.selectedPrestations.forEach(o=>{let n=this.fb.group({designation:[o.designation],description:[o.description],prixUnitaire:[o.prixUnitaire],duree:[1],prixTotal:[o.prixUnitaire]});this.prestationsArray.push(n)}),this.updateTotals(),this.selectedPrestations=[],this.closePrestationModal()}closePrestationModal(){let o=document.getElementById("prestationModal");if(o){let n=bootstrap.Modal.getInstance(o);n&&n.hide()}}updateTotals(){this.totalHT=this.prestationsArray.controls.reduce((r,s)=>r+(s.get("prixTotal")?.value||0),0);let o=this.devisForm.get("tva")?.value||0;this.montantTVA=this.totalHT*o/100;let n=this.devisForm.get("remise")?.value||0;this.montantRemise=this.totalHT*n/100,this.totalTTC=this.totalHT+this.montantTVA-this.montantRemise,this.devisForm.patchValue({prixTotal:this.totalHT,prixTTC:this.totalTTC})}static \u0275fac=function(n){return new(n||a)(C(de),C(Y),C(me),C(ce),C(pe),C(W))};static \u0275cmp=M({type:a,selectors:[["app-add-devis"]],standalone:!1,decls:299,vars:54,consts:[[1,"pc-container"],[1,"row"],[1,"row","pc-content"],[1,"col-md-12"],[1,"card"],[1,"card-header"],[1,"mb-0"],[1,"card-body"],[3,"ngSubmit","formGroup"],[1,"row","mb-3"],[1,"col-md-6"],[1,"form-label"],["type","text","formControlName","reference",1,"form-control"],["type","text","formControlName","nomProjet",1,"form-control"],[1,"col-12"],["formControlName","description","rows","2",1,"form-control"],[1,"col-md-9"],[1,"input-group"],["type","text","formControlName","client","readonly","",1,"form-control",3,"value"],["type","button",1,"btn","btn-outline-secondary",3,"click"],[1,"bx","bx-search-alt"],[1,"col-md-3"],["formControlName","statut",1,"form-select"],["value","BROUILLON"],["for","dateEmission",1,"form-label"],["id","dateEmission","type","date","formControlName","dateEmission",1,"form-control",3,"min","value"],["for","dateEcheance",1,"form-label"],["id","dateEcheance","type","date","formControlName","dateEcheance",1,"form-control",3,"min","value"],[1,"mt-4"],[1,"table-responsive","mb-3"],[1,"table","table-bordered"],[1,"table-light"],["formArrayName","prestations"],[3,"formGroupName",4,"ngFor","ngForOf"],[1,"mb-3"],["type","button",1,"btn","btn-outline-primary",3,"click"],[1,"bx","bx-plus"],["type","button",1,"btn","btn-outline-secondary","ms-2",3,"click"],[1,"bx","bx-list-plus"],["formControlName","notes","rows","4",1,"form-control"],[1,"row","mb-2"],[1,"col-6"],[1,"col-6","text-end"],[1,"input-group","input-group-sm"],["type","number","formControlName","tva",1,"form-control",3,"input"],[1,"input-group-text"],["type","number","formControlName","remise",1,"form-control",3,"input"],[1,"row","fw-bold"],[1,"text-end","mb-5"],["type","button",1,"btn","btn-secondary","me-2",3,"click"],[1,"bx","bx-show"],["type","submit",1,"btn","btn-primary",3,"disabled"],[1,"bx","bx-save"],["class","spinner-border spinner-border-sm ms-1",4,"ngIf"],["class","col-md-12",4,"ngIf"],["id","clientModal","tabindex","-1",1,"modal","fade",2,"display","block","width","40%"],[1,"modal-dialog","modal-lg"],[1,"modal-content"],[1,"modal-header"],[1,"modal-title"],["type","button","data-bs-dismiss","modal",1,"btn-close"],[1,"modal-body"],["type","text","placeholder","Rechercher un client...",1,"form-control","mb-3",3,"ngModelChange","ngModel"],[1,"table-responsive"],[1,"table","table-hover"],[4,"ngFor","ngForOf"],["id","prestationModal","tabindex","-1",1,"modal","fade"],["type","text","placeholder","Rechercher une prestation...",1,"form-control","mb-3",3,"ngModelChange","ngModel"],[1,"modal-footer"],["type","button","data-bs-dismiss","modal",1,"btn","btn-secondary"],["type","button",1,"btn","btn-primary",3,"click","disabled"],["id","previewModal","tabindex","-1",1,"modal","fade"],[1,"modal-dialog","modal-xl"],[1,"devis-preview","p-4"],[1,"row","mb-5"],[1,"mb-1"],["alt","Logo","height","130",3,"src",4,"ngIf"],[1,"client-box","p-3","border"],[1,"devis-info","text-end"],[1,"row","mb-4"],[1,"table-responsive","mb-4"],[1,"table","table-striped"],[1,"table-dark"],[2,"width","5%"],[2,"width","30%"],[1,"text-end",2,"width","10%"],[1,"text-end",2,"width","15%"],[1,"row","justify-content-end","mb-5"],[1,"col-4"],[1,"table","table-sm"],[1,"text-end"],[1,"table-active"],[1,"text-end","fw-bold"],[1,"row","mt-5"],["type","button",1,"btn","btn-primary",3,"click"],[1,"bx","bx-file-pdf"],[3,"formGroupName"],["type","text","formControlName","designation",1,"form-control","form-control-sm"],["type","text","formControlName","description",1,"form-control","form-control-sm"],["type","number","formControlName","prixUnitaire",1,"form-control","form-control-sm",3,"input"],["type","number","formControlName","duree",1,"form-control","form-control-sm",3,"input"],["type","number","formControlName","prixTotal","readonly","",1,"form-control","form-control-sm"],["type","button",1,"btn","btn-sm","btn-danger",3,"click"],[1,"bx","bx-trash"],[1,"spinner-border","spinner-border-sm","ms-1"],[1,"card-header","d-flex","justify-content-between","align-items-center"],["type","button",1,"btn-close",3,"click"],[1,"card-body","preview-pane"],[1,"d-flex","justify-content-between","mb-4"],[1,"text-center","mb-4"],[1,"mb-4"],[1,"row","justify-content-end","mb-4"],[1,"d-flex","justify-content-between","mb-2"],[1,"d-flex","justify-content-between","fw-bold"],[4,"ngIf"],["alt","Logo","height","130",3,"src"],["class","text-muted small",4,"ngIf"],[1,"text-muted","small"],[1,"btn","btn-sm","btn-primary",3,"click"],[1,"form-check"],["type","checkbox",1,"form-check-input",3,"change","checked"]],template:function(n,r){if(n&1&&(t(0,"div",0)(1,"div",1)(2,"div",2)(3,"div",3)(4,"div",4)(5,"div",5)(6,"h4",6),i(7,"Nouveau devis"),e()(),t(8,"div",7)(9,"form",8),x("ngSubmit",function(){return r.onSubmit()}),t(10,"div",9)(11,"div",10)(12,"label",11),i(13,"R\xE9f\xE9rence"),e(),m(14,"input",12),e(),t(15,"div",10)(16,"label",11),i(17,"Nom du projet"),e(),m(18,"input",13),e()(),t(19,"div",9)(20,"div",14)(21,"label",11),i(22,"Description"),e(),m(23,"textarea",15),e()(),t(24,"div",9)(25,"div",16)(26,"label",11),i(27,"Client"),e(),t(28,"div",17),m(29,"input",18),t(30,"button",19),x("click",function(){return r.openClientModal()}),m(31,"i",20),i(32," S\xE9lectionner "),e()()(),t(33,"div",21)(34,"label",11),i(35,"Statut"),e(),t(36,"select",22)(37,"option",23),i(38,"Brouillon"),e()()()(),t(39,"div",9)(40,"div",10)(41,"label",24),i(42,"Date d'\xE9mission"),e(),m(43,"input",25),e(),t(44,"div",10)(45,"label",26),i(46,"Date d'\xE9ch\xE9ance"),e(),m(47,"input",27),e()(),t(48,"h5",28),i(49,"T\xE2ches"),e(),t(50,"div",29)(51,"table",30)(52,"thead",31)(53,"tr")(54,"th"),i(55,"#"),e(),t(56,"th"),i(57,"D\xE9signation"),e(),t(58,"th"),i(59,"Description"),e(),t(60,"th"),i(61,"Prix unitaire"),e(),t(62,"th"),i(63,"Dur\xE9e/Qt\xE9"),e(),t(64,"th"),i(65,"Total"),e(),t(66,"th"),i(67,"Actions"),e()()(),t(68,"tbody",32),_(69,Pt,16,2,"tr",33),e()()(),t(70,"div",34)(71,"button",35),x("click",function(){return r.addEmptyPrestation()}),m(72,"i",36),i(73," Ajouter t\xE2che "),e(),t(74,"button",37),x("click",function(){return r.openPrestationModal()}),m(75,"i",38),i(76," Catalogue "),e()(),t(77,"div",9)(78,"div",10)(79,"div",34)(80,"label",11),i(81,"Notes"),e(),m(82,"textarea",39),e()(),t(83,"div",10)(84,"div",4)(85,"div",7)(86,"div",40)(87,"label",41),i(88,"Total HT"),e(),t(89,"div",42),i(90),e()(),t(91,"div",40)(92,"div",41)(93,"div",43)(94,"input",44),x("input",function(){return r.updateTotals()}),e(),t(95,"span",45),i(96,"% TVA"),e()()(),t(97,"div",42),i(98),e()(),t(99,"div",40)(100,"div",41)(101,"div",43)(102,"input",46),x("input",function(){return r.updateTotals()}),e(),t(103,"span",45),i(104,"% Remise"),e()()(),t(105,"div",42),i(106),e()(),m(107,"hr"),t(108,"div",47)(109,"label",41),i(110,"Total TTC"),e(),t(111,"div",42),i(112),e()()()()()(),t(113,"div",48)(114,"button",49),x("click",function(){return r.previewDevis()}),m(115,"i",50),i(116," Pr\xE9visualiser "),e(),t(117,"button",51),m(118,"i",52),i(119," Enregistrer "),_(120,It,1,0,"span",53),e()()()()()(),_(121,kt,86,30,"div",54),e()()(),t(122,"div",55)(123,"div",56)(124,"div",57)(125,"div",58)(126,"h5",59),i(127,"S\xE9lectionner un client"),e(),m(128,"button",60),e(),t(129,"div",61)(130,"input",62),k("ngModelChange",function(u){return A(r.searchTermClient,u)||(r.searchTermClient=u),u}),e(),t(131,"div",63)(132,"table",64)(133,"thead")(134,"tr")(135,"th"),i(136,"Nom"),e(),t(137,"th"),i(138,"Soci\xE9t\xE9"),e(),t(139,"th"),i(140,"Email"),e(),t(141,"th"),i(142,"Action"),e()()(),t(143,"tbody"),_(144,Lt,10,3,"tr",65),e()()()()()()(),t(145,"div",66)(146,"div",56)(147,"div",57)(148,"div",58)(149,"h5",59),i(150,"Catalogue de t\xE2ches"),e(),m(151,"button",60),e(),t(152,"div",61)(153,"input",67),k("ngModelChange",function(u){return A(r.searchTermPrestation,u)||(r.searchTermPrestation=u),u}),e(),t(154,"div",63)(155,"table",64)(156,"thead")(157,"tr")(158,"th"),i(159,"D\xE9signation"),e(),t(160,"th"),i(161,"Description"),e(),t(162,"th"),i(163,"Prix"),e(),t(164,"th"),i(165,"S\xE9lection"),e()()(),t(166,"tbody"),_(167,Ot,10,4,"tr",65),e()()()(),t(168,"div",68)(169,"button",69),i(170,"Fermer"),e(),t(171,"button",70),x("click",function(){return r.addSelectedPrestations()}),m(172,"i",36),i(173," Ajouter les t\xE2ches s\xE9lectionn\xE9es "),e()()()()(),t(174,"div",71)(175,"div",72)(176,"div",57)(177,"div",58)(178,"h5",59),i(179,"Pr\xE9visualisation du devis"),e(),m(180,"button",60),e(),t(181,"div",61)(182,"div",73)(183,"div",74)(184,"div",41)(185,"h3"),i(186),e(),t(187,"p",75),i(188),e(),t(189,"p",75),i(190),e(),t(191,"p",75),i(192),e(),t(193,"p"),i(194),e()(),t(195,"div",42),_(196,Nt,1,1,"img",76),e()(),t(197,"div",74)(198,"div",41)(199,"div",77)(200,"h5"),i(201,"Client"),e(),t(202,"p",75)(203,"strong"),i(204),e()(),t(205,"p",75),i(206),e(),t(207,"p",75),i(208),e(),t(209,"p",75),i(210),e(),t(211,"p",75),i(212),e(),t(213,"p"),i(214),e()()(),t(215,"div",41)(216,"div",78)(217,"h1",34),i(218),e(),t(219,"p",75)(220,"strong"),i(221,"Projet:"),e(),i(222),e(),t(223,"p",75)(224,"strong"),i(225,"Date d'\xE9mission:"),e(),i(226),E(227,"date"),e(),t(228,"p")(229,"strong"),i(230,"Date d'\xE9ch\xE9ance:"),e(),i(231),E(232,"date"),e()()()(),t(233,"div",79)(234,"div",14)(235,"p"),i(236),e()()(),t(237,"div",80)(238,"table",81)(239,"thead",82)(240,"tr")(241,"th",83),i(242,"#"),e(),t(243,"th",84),i(244,"D\xE9signation"),e(),t(245,"th",84),i(246,"Description"),e(),t(247,"th",85),i(248,"PU HT"),e(),t(249,"th",85),i(250,"Qt\xE9"),e(),t(251,"th",86),i(252,"Total HT"),e()()(),t(253,"tbody"),_(254,Rt,13,6,"tr",65),e()()(),t(255,"div",87)(256,"div",88)(257,"table",89)(258,"tr")(259,"th"),i(260,"Total HT"),e(),t(261,"td",90),i(262),e()(),t(263,"tr")(264,"th"),i(265),e(),t(266,"td",90),i(267),e()(),t(268,"tr")(269,"th"),i(270),e(),t(271,"td",90),i(272),e()(),t(273,"tr",91)(274,"th"),i(275,"Total TTC"),e(),t(276,"td",92),i(277),e()()()()(),t(278,"div",79)(279,"div",14)(280,"h6"),i(281,"Notes"),e(),t(282,"p"),i(283),e()()(),t(284,"div",93)(285,"div",41)(286,"p"),i(287,"Date et signature du client pr\xE9c\xE9d\xE9e de la mention"),m(288,"br"),i(289,"'Bon pour accord'"),e()(),t(290,"div",42)(291,"p"),i(292),e()()()()(),t(293,"div",68)(294,"button",69),i(295,"Fermer"),e(),t(296,"button",94),x("click",function(){return r.exportToPDF()}),m(297,"i",95),i(298," Exporter en PDF "),e()()()()()),n&2){let s,u,T,I,w,d,Te,De;l(9),c("formGroup",r.devisForm),l(20),c("value",(r.selectedClient==null?null:r.selectedClient.nom)||""),l(14),c("min",r.today)("value",r.today),l(4),c("min",r.todayPlusOneMonth)("value",r.todayPlusOneMonth),l(22),c("ngForOf",r.prestationsArray.controls),l(21),p("",r.totalHT," CFA"),l(8),p("",r.montantTVA," CFA"),l(8),p("-",r.montantRemise," CFA"),l(6),p("",r.totalTTC," CFA"),l(5),c("disabled",r.devisForm.invalid||r.loading),l(3),c("ngIf",r.loading),l(),c("ngIf",r.showPreview),l(9),F("ngModel",r.searchTermClient),l(14),c("ngForOf",r.filteredClients),l(9),F("ngModel",r.searchTermPrestation),l(14),c("ngForOf",r.filteredPrestations),l(4),c("disabled",r.selectedPrestations.length===0),l(15),v((r.companyProfile==null?null:r.companyProfile.companyName)||"Votre Entreprise"),l(2),v(r.companyProfile==null?null:r.companyProfile.address),l(2),D("",r.companyProfile==null?null:r.companyProfile.postalCode," ",r.companyProfile==null?null:r.companyProfile.city,""),l(2),v(r.companyProfile==null?null:r.companyProfile.email),l(2),v(r.companyProfile==null?null:r.companyProfile.phoneNumber),l(2),c("ngIf",r.companyProfile==null?null:r.companyProfile.hasLogo),l(8),v(r.selectedClient==null?null:r.selectedClient.nom),l(2),v(r.selectedClient==null?null:r.selectedClient.societe),l(2),v(r.selectedClient==null?null:r.selectedClient.adresse),l(2),D("",r.selectedClient==null?null:r.selectedClient.ville,", ",r.selectedClient==null?null:r.selectedClient.pays,""),l(2),p("TVA: ",r.selectedClient==null?null:r.selectedClient.numeroTVA,""),l(2),D("",r.selectedClient==null?null:r.selectedClient.email," | ",r.selectedClient==null?null:r.selectedClient.telephone,""),l(4),p("Devis ",(s=r.devisForm.get("reference"))==null?null:s.value,""),l(4),p(" ",(u=r.devisForm.get("nomProjet"))==null?null:u.value,""),l(4),p(" ",y(227,48,(T=r.devisForm.get("dateEmission"))==null?null:T.value,"dd/MM/yyyy"),""),l(5),p(" ",y(232,51,(I=r.devisForm.get("dateEcheance"))==null?null:I.value,"dd/MM/yyyy"),""),l(5),v((w=r.devisForm.get("description"))==null?null:w.value),l(18),c("ngForOf",r.prestationsArray.value),l(8),p("",r.totalHT," CFA"),l(3),p("TVA (",(d=r.devisForm.get("tva"))==null?null:d.value,"%)"),l(2),p("",r.montantTVA," CFA"),l(3),p("Remise (",(Te=r.devisForm.get("remise"))==null?null:Te.value,"%)"),l(2),p("-",r.montantRemise," CFA"),l(5),p("",r.totalTTC," CFA"),l(6),v(((De=r.devisForm.get("notes"))==null?null:De.value)||"Aucune note"),l(9),v(r.companyProfile==null?null:r.companyProfile.companyName)}},dependencies:[N,R,ne,H,z,B,re,G,q,ie,$,oe,se,le,ae,V],encapsulation:2})};function Vt(a,o){if(a&1){let n=S();t(0,"tr",71)(1,"td"),i(2),e(),t(3,"td"),m(4,"input",72),e(),t(5,"td"),m(6,"input",73),e(),t(7,"td")(8,"input",74),x("input",function(){let s=h(n).index,u=f();return b(u.updatePrestationTotal(s))}),e()(),t(9,"td")(10,"input",75),x("input",function(){let s=h(n).index,u=f();return b(u.updatePrestationTotal(s))}),e()(),t(11,"td"),m(12,"input",76),e(),t(13,"td")(14,"button",77),x("click",function(){let s=h(n).index,u=f();return b(u.removePrestation(s))}),m(15,"i",55),e()()()}if(a&2){let n=o.index;c("formGroupName",n),l(2),v(n+1)}}function jt(a,o){a&1&&m(0,"span",78)}function Ut(a,o){if(a&1&&m(0,"img",93),a&2){let n=f(2);c("src",n.previewUrl,Q)}}function Bt(a,o){if(a&1&&(t(0,"div",95),i(1),e()),a&2){let n=f().$implicit;l(),v(n.description)}}function qt(a,o){if(a&1&&(t(0,"tr")(1,"td"),i(2),_(3,Bt,2,1,"div",94),e(),t(4,"td",88),i(5),e(),t(6,"td",88),i(7),e(),t(8,"td",88),i(9),e()()),a&2){let n=o.$implicit;l(2),p(" ",n.designation," "),l(),c("ngIf",n.description),l(2),p("",n.prixUnitaire," CFA"),l(2),v(n.duree),l(2),p("",n.prixTotal," CFA")}}function $t(a,o){if(a&1&&(t(0,"div",86)(1,"h5"),i(2,"Notes"),e(),t(3,"p"),i(4),e()()),a&2){let n,r=f(2);l(4),v((n=r.devisForm.get("notes"))==null?null:n.value)}}function Gt(a,o){if(a&1){let n=S();t(0,"div",3)(1,"div",4)(2,"div",79)(3,"h5",6),i(4,"Aper\xE7u"),e(),t(5,"button",80),x("click",function(){h(n);let s=f();return b(s.showPreview=!1)}),e()(),t(6,"div",81)(7,"div",82)(8,"div")(9,"h4"),i(10),e(),t(11,"p",83),i(12),e(),t(13,"p",83),i(14),e(),t(15,"p"),i(16),e()(),t(17,"div"),_(18,Ut,1,1,"img",84),e()(),t(19,"div",85)(20,"h2"),i(21),e(),t(22,"p"),i(23),e()(),t(24,"div",9)(25,"div",44)(26,"p")(27,"strong"),i(28,"Date:"),e(),i(29),E(30,"date"),e()(),t(31,"div",45)(32,"p")(33,"strong"),i(34,"\xC9ch\xE9ance:"),e(),i(35),E(36,"date"),e()()(),t(37,"div",86)(38,"h5"),i(39,"Client"),e(),t(40,"p",83),i(41),e(),t(42,"p",83),i(43),e(),t(44,"p",83),i(45),e(),t(46,"p"),i(47),e()(),t(48,"div",32)(49,"table",87)(50,"thead")(51,"tr")(52,"th"),i(53,"D\xE9signation"),e(),t(54,"th",88),i(55,"PU"),e(),t(56,"th",88),i(57,"Qt\xE9"),e(),t(58,"th",88),i(59,"Total"),e()()(),t(60,"tbody"),_(61,qt,10,5,"tr",70),e()()(),t(62,"div",89)(63,"div",44)(64,"div",90)(65,"span"),i(66,"Total HT:"),e(),t(67,"span"),i(68),e()(),t(69,"div",90)(70,"span"),i(71),e(),t(72,"span"),i(73),e()(),t(74,"div",90)(75,"span"),i(76),e(),t(77,"span"),i(78),e()(),t(79,"div",91)(80,"span"),i(81,"Total TTC:"),e(),t(82,"span"),i(83),e()()()(),_(84,$t,5,1,"div",92),e()()()}if(a&2){let n,r,s,u,T,I,w,d=f();l(10),v((d.companyProfile==null?null:d.companyProfile.companyName)||"Votre Entreprise"),l(2),v(d.companyProfile==null?null:d.companyProfile.address),l(2),D("",d.companyProfile==null?null:d.companyProfile.postalCode," ",d.companyProfile==null?null:d.companyProfile.city,""),l(2),D("",d.companyProfile==null?null:d.companyProfile.email," | ",d.companyProfile==null?null:d.companyProfile.phoneNumber,""),l(2),c("ngIf",d.companyProfile==null?null:d.companyProfile.hasLogo),l(3),p("Devis ",(n=d.devisForm.get("reference"))==null?null:n.value,""),l(2),p("Projet: ",(r=d.devisForm.get("nomProjet"))==null?null:r.value,""),l(6),p(" ",y(30,24,(s=d.devisForm.get("dateEmission"))==null?null:s.value,"dd/MM/yyyy"),""),l(6),p(" ",y(36,27,(u=d.devisForm.get("dateEcheance"))==null?null:u.value,"dd/MM/yyyy"),""),l(6),v(d.selectedClient==null?null:d.selectedClient.nom),l(2),v(d.selectedClient==null?null:d.selectedClient.societe),l(2),v(d.selectedClient==null?null:d.selectedClient.adresse),l(2),D("",d.selectedClient==null?null:d.selectedClient.email," | ",d.selectedClient==null?null:d.selectedClient.telephone,""),l(14),c("ngForOf",d.prestationsArray.value),l(7),p("",d.totalHT," CFA"),l(3),p("TVA (",(T=d.devisForm.get("tva"))==null?null:T.value,"%):"),l(2),p("",d.montantTVA," CFA"),l(3),p("Remise (",(I=d.devisForm.get("remise"))==null?null:I.value,"%):"),l(2),p("-",d.montantRemise," CFA"),l(5),p("",d.totalTTC," CFA"),l(),c("ngIf",(w=d.devisForm.get("notes"))==null?null:w.value)}}function Ht(a,o){if(a&1){let n=S();t(0,"tr")(1,"td"),i(2),e(),t(3,"td"),i(4),e(),t(5,"td"),i(6),e(),t(7,"td")(8,"button",96),x("click",function(){let s=h(n).$implicit,u=f();return b(u.selectPrestation(s))}),i(9," Ajouter "),e()()()}if(a&2){let n=o.$implicit;l(2),v(n.designation),l(2),v(n.description),l(2),p("",n.prixUnitaire," CFA")}}var fe=class a{constructor(o,n,r,s,u,T,I,w,d){this.fb=o;this.route=n;this.router=r;this.devisService=s;this.clientService=u;this.prestationService=T;this.companyProfileService=I;this.messageService=w;this.confirmationService=d;this.devisForm=this.fb.group({reference:["",g.required],nomProjet:["",g.required],description:[""],client:["",g.required],statut:["BROUILLON",g.required],dateEmission:["",g.required],dateEcheance:["",g.required],prestations:this.fb.array([]),tva:[0],remise:[0],notes:[""]})}devisForm;isLoading=!1;errorMessage="";clients=[];selectedClient=null;companyProfile=null;previewUrl="";showPreview=!1;prestations=[];filteredPrestations=[];searchTermPrestation="";prestationModal;ngOnInit(){this.loadDevis(),this.loadClients(),this.loadCompanyProfile(),this.loadPrestations(),this.initModals()}initModals(){setTimeout(()=>{this.prestationModal=new bootstrap.Modal(document.getElementById("prestationModal"))},500)}loadPrestations(){this.prestationService.findByCreatedBy().subscribe(o=>{this.prestations=o||[],this.filteredPrestations=[...this.prestations],console.log("Prestations charg\xE9es:",this.prestations)},o=>console.error("Erreur lors du chargement des prestations:",o))}get prestationsArray(){return this.devisForm.get("prestations")}get totalHT(){return this.prestationsArray.controls.reduce((o,n)=>o+(n.get("prixTotal")?.value||0),0)}get montantTVA(){return this.totalHT*(this.devisForm.get("tva")?.value||0)/100}get montantRemise(){return this.totalHT*(this.devisForm.get("remise")?.value||0)/100}get totalTTC(){return this.totalHT+this.montantTVA-this.montantRemise}loadDevis(){let o=this.route.snapshot.paramMap.get("id");if(!o){this.errorMessage="ID du devis non trouv\xE9";return}this.isLoading=!0,this.devisService.findByTrackingId(o).subscribe({next:n=>{let r=n.data;this.devisForm.patchValue({reference:r.reference,nomProjet:r.nomProjet,description:r.description,client:r.clientName,statut:r.statut,dateEmission:r.dateEmission,dateEcheance:r.dateEcheance,tva:r.tva,remise:r.remise,notes:r.notes}),this.selectedClient={trackingId:r.clientTrackingId,nom:r.clientName,email:r.clientEmail},this.prestationsArray.clear(),r.prestations.forEach(s=>{this.prestationsArray.push(this.fb.group({trackingId:[s.trackingId],designation:[s.designation],description:[s.description],prixUnitaire:[s.prixUnitaire],duree:[s.duree],prixTotal:[s.prixTotal]}))}),this.isLoading=!1},error:n=>{this.errorMessage="Erreur lors du chargement du devis",this.isLoading=!1,console.error("Erreur:",n)}})}loadClients(){this.clientService.getClients().subscribe({next:o=>{this.clients=o.data||o._embedded.clients},error:o=>{console.error("Erreur lors du chargement des clients:",o)}})}loadCompanyProfile(){this.companyProfileService.getProfile().subscribe({next:o=>{this.companyProfile=o,o.hasLogo&&(this.previewUrl=`${Ve.apiUrl}/api/profile/logo/${o.trackingId}`)},error:o=>{console.error("Erreur lors du chargement du profil entreprise:",o)}})}openClientModal(){}openPrestationModal(){this.searchTermPrestation="",this.filteredPrestations=[...this.prestations],console.log("Ouverture modal prestations, prestations disponibles:",this.filteredPrestations.length),this.prestationModal.show()}selectPrestation(o){let n=o.trackingId||this.generateTrackingId(),r=this.fb.group({trackingId:[n,g.required],designation:[o.designation,g.required],description:[o.description||""],prixUnitaire:[o.prixUnitaire,[g.required,g.min(0)]],duree:[1,[g.required,g.min(.1)]],prixTotal:[o.prixUnitaire,g.required]});this.prestationsArray.push(r),this.updateTotals(),this.prestationModal.hide(),console.log("Prestation s\xE9lectionn\xE9e ajout\xE9e:",o,"index:",this.prestationsArray.length-1)}generateTrackingId(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(o){let n=Math.random()*16|0;return(o==="x"?n:n&3|8).toString(16)})}addEmptyPrestation(){let o=this.fb.group({trackingId:[this.generateTrackingId(),g.required],designation:["",g.required],description:[""],prixUnitaire:[0,[g.required,g.min(0)]],duree:[1,[g.required,g.min(.1)]],prixTotal:[0,g.required]});this.prestationsArray.push(o),console.log("Nouvelle prestation vide ajout\xE9e:",o.value),this.updateTotals()}removePrestation(o){this.prestationsArray.removeAt(o),console.log("Suppression prestation index:",o,"prestations restantes:",this.prestationsArray.value),this.updateTotals()}updatePrestationTotal(o){let n=this.prestationsArray.at(o),r=n.get("prixUnitaire")?.value||0,s=n.get("duree")?.value||0,u=r*s;n.get("prixTotal")?.setValue(u),console.log("Mise \xE0 jour du total pour la prestation:",{index:o,prixUnitaire:r,duree:s,prixTotal:u}),this.updateTotals()}updateTotals(){console.log("Mise \xE0 jour des totaux:",{totalHT:this.totalHT,montantTVA:this.montantTVA,montantRemise:this.montantRemise,totalTTC:this.totalTTC})}previewDevis(){this.showPreview=!0}onSubmit(){if(this.devisForm.invalid||!this.selectedClient){this.errorMessage="Veuillez s\xE9lectionner un client";return}this.isLoading=!0;let o={reference:this.devisForm.get("reference")?.value,nomProjet:this.devisForm.get("nomProjet")?.value,description:this.devisForm.get("description")?.value,client:this.selectedClient,dateEmission:this.devisForm.get("dateEmission")?.value,dateEcheance:this.devisForm.get("dateEcheance")?.value,prixTotal:this.totalHT,prixTTC:this.totalTTC,tva:this.devisForm.get("tva")?.value,remise:this.devisForm.get("remise")?.value,statut:this.devisForm.get("statut")?.value,notes:this.devisForm.get("notes")?.value,prestations:this.prestationsArray.controls.map(r=>({trackingId:r.get("trackingId")?.value,designation:r.get("designation")?.value,description:r.get("description")?.value,prixUnitaire:r.get("prixUnitaire")?.value,duree:r.get("duree")?.value,prixTotal:r.get("prixTotal")?.value}))};console.log("Donn\xE9es envoy\xE9es:",JSON.stringify(o,null,2));let n=this.route.snapshot.paramMap.get("id");if(!n){this.errorMessage="ID du devis non trouv\xE9",this.isLoading=!1;return}this.devisService.update(n,o).subscribe({next:r=>{console.log("R\xE9ponse du serveur:",r),this.router.navigate(["/dashboard/devis"])},error:r=>{console.error("Erreur compl\xE8te:",r),console.error("D\xE9tails de l'erreur:",r.error),this.errorMessage="Erreur lors de la mise \xE0 jour du devis: "+(r.error?.message||r.message),this.isLoading=!1}})}deleteDevis(){let o=this.route.snapshot.paramMap.get("id");if(!o){this.errorMessage="ID du devis non trouv\xE9";return}this.confirmationService.confirm({message:"\xCAtes-vous s\xFBr de vouloir supprimer ce devis ?",header:"Confirmation de suppression",icon:"pi pi-exclamation-triangle",acceptLabel:"Oui, supprimer",rejectLabel:"Non, annuler",accept:()=>{this.isLoading=!0,this.devisService.deleteDevis(o).subscribe({next:()=>{this.messageService.add({severity:"success",summary:"Succ\xE8s",detail:"Devis supprim\xE9 avec succ\xE8s"}),this.router.navigate(["/dashboard/devis"])},error:n=>{this.isLoading=!1,this.messageService.add({severity:"error",summary:"Erreur",detail:`Erreur lors de la suppression du devis: ${n.error?.message||"Erreur inconnue"}`}),console.error("Erreur de suppression:",n)}})}})}static \u0275fac=function(n){return new(n||a)(C(de),C(Oe),C(W),C(Y),C(me),C(ce),C(pe),C(U),C(j))};static \u0275cmp=M({type:a,selectors:[["app-edit-devis"]],standalone:!1,features:[Ie([U,j])],decls:156,vars:12,consts:[[1,"pc-container"],[1,"row"],[1,"row","pc-content"],[1,"col-md-12"],[1,"card"],[1,"card-header"],[1,"mb-0"],[1,"card-body"],[3,"ngSubmit","formGroup"],[1,"row","mb-3"],[1,"col-md-6"],[1,"form-label"],["type","text","formControlName","reference","readonly","",1,"form-control"],["type","text","formControlName","nomProjet",1,"form-control"],[1,"col-12"],["formControlName","description","rows","2",1,"form-control"],[1,"col-md-9"],[1,"input-group"],["type","text","formControlName","client","readonly","",1,"form-control",3,"value"],["type","button",1,"btn","btn-outline-secondary",3,"click"],[1,"bx","bx-search-alt"],[1,"col-md-3"],["formControlName","statut",1,"form-select"],["value","BROUILLON"],["value","ENVOY\xC9"],["value","ACCEPT\xC9"],["value","REFUS\xC9"],["for","dateEmission",1,"form-label"],["id","dateEmission","type","date","formControlName","dateEmission",1,"form-control"],["for","dateEcheance",1,"form-label"],["id","dateEcheance","type","date","formControlName","dateEcheance",1,"form-control"],[1,"mt-4"],[1,"table-responsive","mb-3"],[1,"table","table-bordered"],[1,"table-light"],["formArrayName","prestations"],[3,"formGroupName",4,"ngFor","ngForOf"],[1,"mb-3"],["type","button",1,"btn","btn-outline-primary",3,"click"],[1,"bx","bx-plus"],["type","button",1,"btn","btn-outline-secondary","ms-2",3,"click"],[1,"bx","bx-list-plus"],["formControlName","notes","rows","4",1,"form-control"],[1,"row","mb-2"],[1,"col-6"],[1,"col-6","text-end"],[1,"input-group","input-group-sm"],["type","number","formControlName","tva",1,"form-control",3,"input"],[1,"input-group-text"],["type","number","formControlName","remise",1,"form-control",3,"input"],[1,"row","fw-bold"],[1,"text-end","mb-5"],["type","button",1,"btn","btn-secondary","me-2",3,"click"],[1,"bx","bx-show"],["type","button",1,"btn","btn-danger","me-2",3,"click"],[1,"bx","bx-trash"],["type","submit",1,"btn","btn-primary",3,"disabled"],[1,"bx","bx-save"],["class","spinner-border spinner-border-sm ms-1",4,"ngIf"],["class","col-md-12",4,"ngIf"],["id","prestationModal","tabindex","-1",1,"modal","fade"],[1,"modal-dialog","modal-lg"],[1,"modal-content"],[1,"modal-header"],[1,"modal-title"],["type","button","data-bs-dismiss","modal",1,"btn-close"],[1,"modal-body"],["type","text","placeholder","Rechercher une prestation...",1,"form-control","mb-3",3,"ngModelChange","ngModel"],[1,"table-responsive"],[1,"table","table-hover"],[4,"ngFor","ngForOf"],[3,"formGroupName"],["type","text","formControlName","designation",1,"form-control","form-control-sm"],["type","text","formControlName","description",1,"form-control","form-control-sm"],["type","number","formControlName","prixUnitaire",1,"form-control","form-control-sm",3,"input"],["type","number","formControlName","duree",1,"form-control","form-control-sm",3,"input"],["type","number","formControlName","prixTotal","readonly","",1,"form-control","form-control-sm"],["type","button",1,"btn","btn-sm","btn-danger",3,"click"],[1,"spinner-border","spinner-border-sm","ms-1"],[1,"card-header","d-flex","justify-content-between","align-items-center"],["type","button",1,"btn-close",3,"click"],[1,"card-body","preview-pane"],[1,"d-flex","justify-content-between","mb-4"],[1,"mb-1"],["alt","Logo","height","130",3,"src",4,"ngIf"],[1,"text-center","mb-4"],[1,"mb-4"],[1,"table","table-sm"],[1,"text-end"],[1,"row","justify-content-end","mb-4"],[1,"d-flex","justify-content-between","mb-2"],[1,"d-flex","justify-content-between","fw-bold"],["class","mb-4",4,"ngIf"],["alt","Logo","height","130",3,"src"],["class","text-muted small",4,"ngIf"],[1,"text-muted","small"],[1,"btn","btn-sm","btn-primary",3,"click"]],template:function(n,r){n&1&&(m(0,"p-toast")(1,"p-confirmDialog"),t(2,"div",0)(3,"div",1)(4,"div",2)(5,"div",3)(6,"div",4)(7,"div",5)(8,"h4",6),i(9,"Modifier le devis"),e()(),t(10,"div",7)(11,"form",8),x("ngSubmit",function(){return r.onSubmit()}),t(12,"div",9)(13,"div",10)(14,"label",11),i(15,"R\xE9f\xE9rence"),e(),m(16,"input",12),e(),t(17,"div",10)(18,"label",11),i(19,"Nom du projet"),e(),m(20,"input",13),e()(),t(21,"div",9)(22,"div",14)(23,"label",11),i(24,"Description"),e(),m(25,"textarea",15),e()(),t(26,"div",9)(27,"div",16)(28,"label",11),i(29,"Client"),e(),t(30,"div",17),m(31,"input",18),t(32,"button",19),x("click",function(){return r.openClientModal()}),m(33,"i",20),i(34," S\xE9lectionner "),e()()(),t(35,"div",21)(36,"label",11),i(37,"Statut"),e(),t(38,"select",22)(39,"option",23),i(40,"Brouillon"),e(),t(41,"option",24),i(42,"Envoy\xE9"),e(),t(43,"option",25),i(44,"Accept\xE9"),e(),t(45,"option",26),i(46,"Refus\xE9"),e()()()(),t(47,"div",9)(48,"div",10)(49,"label",27),i(50,"Date d'\xE9mission"),e(),m(51,"input",28),e(),t(52,"div",10)(53,"label",29),i(54,"Date d'\xE9ch\xE9ance"),e(),m(55,"input",30),e()(),t(56,"h5",31),i(57,"Prestations"),e(),t(58,"div",32)(59,"table",33)(60,"thead",34)(61,"tr")(62,"th"),i(63,"#"),e(),t(64,"th"),i(65,"D\xE9signation"),e(),t(66,"th"),i(67,"Description"),e(),t(68,"th"),i(69,"Prix unitaire"),e(),t(70,"th"),i(71,"Dur\xE9e/Qt\xE9"),e(),t(72,"th"),i(73,"Total"),e(),t(74,"th"),i(75,"Actions"),e()()(),t(76,"tbody",35),_(77,Vt,16,2,"tr",36),e()()(),t(78,"div",37)(79,"button",38),x("click",function(){return r.addEmptyPrestation()}),m(80,"i",39),i(81," Ajouter prestation "),e(),t(82,"button",40),x("click",function(){return r.openPrestationModal()}),m(83,"i",41),i(84," Catalogue "),e()(),t(85,"div",9)(86,"div",10)(87,"div",37)(88,"label",11),i(89,"Notes"),e(),m(90,"textarea",42),e()(),t(91,"div",10)(92,"div",4)(93,"div",7)(94,"div",43)(95,"label",44),i(96,"Total HT"),e(),t(97,"div",45),i(98),e()(),t(99,"div",43)(100,"div",44)(101,"div",46)(102,"input",47),x("input",function(){return r.updateTotals()}),e(),t(103,"span",48),i(104,"% TVA"),e()()(),t(105,"div",45),i(106),e()(),t(107,"div",43)(108,"div",44)(109,"div",46)(110,"input",49),x("input",function(){return r.updateTotals()}),e(),t(111,"span",48),i(112,"% Remise"),e()()(),t(113,"div",45),i(114),e()(),m(115,"hr"),t(116,"div",50)(117,"label",44),i(118,"Total TTC"),e(),t(119,"div",45),i(120),e()()()()()(),t(121,"div",51)(122,"button",52),x("click",function(){return r.previewDevis()}),m(123,"i",53),i(124," Pr\xE9visualiser "),e(),t(125,"button",54),x("click",function(){return r.deleteDevis()}),m(126,"i",55),i(127," Supprimer "),e(),t(128,"button",56),m(129,"i",57),i(130," Enregistrer "),_(131,jt,1,0,"span",58),e()()()()()(),_(132,Gt,85,30,"div",59),e()()(),t(133,"div",60)(134,"div",61)(135,"div",62)(136,"div",63)(137,"h5",64),i(138,"Catalogue de prestations"),e(),m(139,"button",65),e(),t(140,"div",66)(141,"input",67),k("ngModelChange",function(u){return A(r.searchTermPrestation,u)||(r.searchTermPrestation=u),u}),e(),t(142,"div",68)(143,"table",69)(144,"thead")(145,"tr")(146,"th"),i(147,"D\xE9signation"),e(),t(148,"th"),i(149,"Description"),e(),t(150,"th"),i(151,"Prix"),e(),t(152,"th"),i(153,"Action"),e()()(),t(154,"tbody"),_(155,Ht,10,3,"tr",70),e()()()()()()()),n&2&&(l(11),c("formGroup",r.devisForm),l(20),c("value",(r.selectedClient==null?null:r.selectedClient.nom)||""),l(46),c("ngForOf",r.prestationsArray.controls),l(21),p("",r.totalHT," CFA"),l(8),p("",r.montantTVA," CFA"),l(8),p("-",r.montantRemise," CFA"),l(6),p("",r.totalTTC," CFA"),l(8),c("disabled",r.devisForm.invalid||r.isLoading),l(3),c("ngIf",r.isLoading),l(),c("ngIf",r.showPreview),l(9),F("ngModel",r.searchTermPrestation),l(14),c("ngForOf",r.filteredPrestations))},dependencies:[N,R,ne,H,z,B,re,G,q,ie,$,oe,se,le,ae,Ue,qe,V],encapsulation:2})};var xe=class a{static \u0275fac=function(n){return new(n||a)};static \u0275cmp=M({type:a,selectors:[["app-devis"]],standalone:!1,decls:1,vars:0,template:function(n,r){n&1&&m(0,"router-outlet")},dependencies:[Ne],encapsulation:2})};var zt=[{path:"",component:xe,children:[{path:"",component:ue},{path:"add-devis",component:ve},{path:"edit-devis/:id",component:fe}]}],ge=class a{static \u0275fac=function(n){return new(n||a)};static \u0275mod=te({type:a});static \u0275inj=ee({imports:[K.forChild(zt),K]})};var We=class a{static \u0275fac=function(n){return new(n||a)};static \u0275mod=te({type:a});static \u0275inj=ee({providers:[U,j],imports:[Ae,K,ge,ke,Le,Be,$e]})};export{We as DevisModule};
